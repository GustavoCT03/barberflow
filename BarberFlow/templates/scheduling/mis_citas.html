<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Seleccionar Barbero y Horario</title>
    <style>
        body { font-family: Arial; max-width: 1200px; margin: 0 auto; padding: 20px; background:#f5f5f5; }
        h1 { margin-top:0; }
        .barbero-card { border: 1px solid #ddd; padding: 15px; margin: 12px 0; border-radius: 8px; background:#fff; }
        .slot-btn { padding: 10px 15px; margin: 5px 0; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .slot-btn:hover { background: #0056b3; }
        .rating { color: #ffc107; font-size: 1.0em; }
        .promo-group { margin-top:8px; display:flex; flex-direction:column; gap:4px; }
        .promo-group input { padding:6px 8px; border:1px solid #ccc; border-radius:4px; width:180px; }
        .promo-group small { color:#666; font-size:12px; }
        form.slot-form { display:inline-block; margin:4px 8px 4px 0; }
        .slots-wrapper { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start; }
        .back-link { display:inline-block; margin-top:25px; }
        .date-filter { background:#fff; padding:12px 16px; border-radius:8px; border:1px solid #ddd; margin-bottom:18px; }
        button[type=submit].slot-btn { display:block; width:100%; }
        .slot-form-inner { display:flex; flex-direction:column; align-items:flex-start; gap:6px; }
    </style>
</head>
<body>
    <h1>{{ sucursal.nombre }} - {{ servicio.nombre }}</h1>
    
    <form method="get" class="date-filter">
        <label for="fecha">Fecha:</label>
        <input id="fecha" type="date" name="fecha" value="{{ fecha_seleccionada }}" min="{{ fecha_seleccionada }}">
        <button type="submit">Buscar disponibilidad</button>
    </form>

    <div>
        {% for info in barberos_info %}
            <div class="barbero-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">{{ info.barbero.nombre }}</h3>
                    <div class="rating">
                        {% if info.total > 0 %}
                            ⭐ {{ info.promedio }}/5 ({{ info.total }} valoración{{ info.total|pluralize:"es" }})
                        {% else %}
                            <span style="color:#999;">Sin valoraciones</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if info.barbero.id in disponibilidad.keys %}
                    <h4 style="margin-top:14px;">Horarios disponibles:</h4>
                    <div class="slots-wrapper">
                        {% for slot in info.slots %}
                            <form method="post"
                                  action="{% url 'scheduling:confirmar_reserva' sucursal.id servicio.id info.barbero.id %}"
                                  class="slot-form">
                                {% csrf_token %}
                                <div class="slot-form-inner">
                                    <input type="hidden" name="fecha_hora" value="{{ fecha_seleccionada }}T{{ slot|time:'H:i:s' }}">
                                    
                                    <button type="submit" class="slot-btn">
                                        {{ slot|time:'H:i' }}
                                    </button>
                                    
                                    <!-- Campo código de promoción (opcional) -->
                                    <div class="promo-group">
                                        <label style="font-size:12px;">Código Promo:</label>
                                        <input type="text"
                                               name="codigo_promocion"
                                               placeholder="DESCUENTO10"
                                               maxlength="30">
                                        <small>Ingresa tu código si tienes uno</small>
                                    </div>
                                </div>
                            </form>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No disponible este día</p>
                    <a class="slot-btn"
                       style="background:#6c757d;"
                       href="{% url 'scheduling:unirse_waitlist' info.barbero.id servicio.id %}">
                       Unirse a lista de espera
                    </a>
                {% endif %}
            </div>
        {% empty %}
            <p>No hay barberos disponibles en esta sucursal.</p>
        {% endfor %}
    </div>

    <a href="{% url 'scheduling:seleccionar_servicio' sucursal.id %}" class="back-link">← Volver</a>
</body>
</html>