<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Citas - BarberFlow</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; max-width:1200px; margin:0 auto; padding:20px; background:#f5f5f5; }
        h1 { margin-top:0; }
        .cita-card { border:1px solid #ddd; border-radius:8px; padding:20px; margin:15px 0; background:#fff; position:relative; }
        .btn { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; text-decoration:none; display:inline-block; font-size:14px; }
        .btn-primary { background:#007bff; color:#fff; }
        .btn-danger { background:#dc3545; color:#fff; }
        .btn-warning { background:#ffc107; color:#000; }
        .btn-secondary { background:#6c757d; color:#fff; }
        .estado { display:inline-block; padding:5px 10px; border-radius:15px; font-size:.85em; font-weight:bold; }
        .pendiente { background:#ffc107; }
        .confirmada { background:#28a745; color:#fff; }
        .completada { background:#6c757d; color:#fff; }
        .cancelada { background:#dc3545; color:#fff; }
        .alert { padding:15px; margin:15px 0; border-radius:5px; }
        .alert-success { background:#d4edda; color:#155724; }
        .alert-error { background:#f8d7da; color:#721c24; }
        .promo-tag { position:absolute; top:8px; right:8px; background:#17a2b8; color:#fff; padding:4px 10px; border-radius:12px; font-size:12px; }
        .descuento { background:#e6ffe6; border:1px dashed #28a745; padding:8px 12px; border-radius:6px; margin-top:8px; font-size:.9em; }
        .sucursales-rapidas a { margin:0 6px 6px 0; }
        .stars { color:#ffc107; font-size:1.2em; line-height:1; }
        .nota-valoracion { background:#fff3cd; padding:10px; border-radius:5px; margin-top:10px; }
    </style>
</head>
<body>
    <h1>Mis Citas</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div style="margin-bottom:20px;">
        <a href="{% url 'scheduling:seleccionar_barberia' %}" class="btn btn-primary">+ Nueva Cita</a>
        <a href="{% url 'panel_cliente' %}" class="btn btn-secondary">‚Üê Volver al Panel</a>
    </div>

    {% if sucursales %}
    <div class="sucursales-rapidas" style="margin-bottom:15px;">
        <strong>Accesos r√°pidos a sucursales:</strong><br>
        {% for s in sucursales %}
            <a class="btn btn-secondary btn-sm" style="padding:6px 12px; font-size:12px;"
               href="{% url 'scheduling:seleccionar_servicio' s.id %}">{{ s.nombre }}</a>
        {% endfor %}
    </div>
    {% endif %}

    {% if citas %}
        {% for cita in citas %}
            <div class="cita-card">
                {% if cita.promocion %}
                    <div class="promo-tag">{{ cita.promocion.codigo }}</div>
                {% endif %}
                <h3 style="margin-top:0;">{{ cita.servicio.nombre }}</h3>

                <p><strong>üìÖ Fecha:</strong> {{ cita.fecha_hora|date:"d/m/Y" }}</p>
                <p><strong>üïê Hora:</strong> {{ cita.fecha_hora|date:"H:i" }}</p>
                <p><strong>üíà Barbero:</strong> {{ cita.barbero.nombre }}</p>
                <p><strong>üìç Sucursal:</strong> {{ cita.sucursal.nombre }}</p>

                <p><strong>üí∞ Precio:</strong>
                    {% if cita.descuento_aplicado and cita.descuento_aplicado > 0 %}
                        <span style="text-decoration:line-through; color:#888;">${{ cita.servicio.precio }}</span>
                        <strong style="color:#28a745;"> ${{ cita.precio }}</strong>
                    {% else %}
                        ${{ cita.precio }}
                    {% endif %}
                </p>

                {% if cita.descuento_aplicado and cita.descuento_aplicado > 0 %}
                    <div class="descuento">
                        Descuento aplicado: ${{ cita.descuento_aplicado }} ¬∑ Promoci√≥n: {{ cita.promocion.nombre }}
                    </div>
                {% endif %}

                <p><strong>Estado:</strong>
                    <span class="estado {{ cita.estado }}">{{ cita.get_estado_display }}</span>
                </p>

                {% if cita.notas %}
                    <p><strong>Notas:</strong> {{ cita.notas }}</p>
                {% endif %}

                {% if cita.estado == 'pendiente' or cita.estado == 'confirmada' %}
                    <form method="post" action="{% url 'scheduling:cancelar_cita' cita.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger"
                                onclick="return confirm('¬øCancelar esta cita?');">
                            ‚úó Cancelar Cita
                        </button>
                    </form>
                {% elif cita.estado == 'completada' %}
                    {% if cita.valoracion %}
                        <div class="nota-valoracion">
                            <span class="stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= cita.valoracion.puntuacion %}‚òÖ{% else %}‚òÜ{% endif %}
                                {% endfor %}
                            </span>
                            {% if cita.valoracion.comentario %}
                                <p style="font-style:italic; color:#555; margin-top:6px;">
                                    ‚Äú{{ cita.valoracion.comentario }}‚Äù
                                </p>
                            {% endif %}
                        </div>
                    {% else %}
                        <a href="{% url 'scheduling:valorar_cita' cita.id %}" class="btn btn-warning">
                            ‚≠ê Valorar Servicio
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div class="cita-card" style="text-align:center; padding:40px;">
            <h2>üìÖ No tienes citas programadas</h2>
            <p>Agenda tu primera cita y disfruta de nuestros servicios.</p>
            <a href="{% url 'scheduling:seleccionar_barberia' %}" class="btn btn-primary" style="margin-top:20px;">
                Agendar Primera Cita
            </a>
        </div>
    {% endif %}
</body>
</html>